$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "Mqtt-Hero-Tenant-Deployment"
title: "IoT Tenant Deployment Schema"
description: "Declarative schema for multi-tenant IoT deployments: topology, device/message classifications, and communication policies."
type: object
additionalProperties: false
required: [schema_version, tenants]

properties:
  schema_version:
    type: string
    title: "Schema Version"
    description: "Schema version for forward-compatible evolution (e.g., 1.0, 1.1)."
    pattern: "^[0-9]+\\.[0-9]+$"
    examples: ["1.0"]

  tenants:
    type: object
    title: "Tenants"
    description: "Map of tenant identifiers to tenant configurations."
    minProperties: 1
    additionalProperties:
      $ref: "#/$defs/Tenant"

$defs:

  # -------------------------
  # Tenant
  # -------------------------
  Tenant:
    type: object
    title: "Tenant"
    description: "An isolated IoT environment (customer, MSP client, or internal environment)."
    additionalProperties: false
    required: [meta, topology, definitions, policies]

    properties:
      meta:
        $ref: "#/$defs/TenantMeta"

      topology:
        $ref: "#/$defs/Topology"

      definitions:
        $ref: "#/$defs/Definitions"

      policies:
        type: array
        title: "Policies"
        description: "Communication rules constraining device/message interactions. Cross-references validated at runtime (loader/reference checks)."
        default: []
        minItems: 0
        items:
          $ref: "#/$defs/Policy"

  TenantMeta:
    type: object
    title: "Tenant Metadata"
    description: "Human-readable and API-relevant metadata describing the tenant."
    additionalProperties: false
    required: [full_name, short_name, api_version, description]

    properties:
      full_name:
        type: string
        title: "Full Name"
        description: "Descriptive name of the tenant."
        minLength: 2
        maxLength: 63
        examples: ["AgriTech Solutions"]

      short_name:
        type: string
        title: "Short Name"
        description: "Short, stable identifier used in APIs, topics, and URLs (lowercase kebab-case recommended)."
        pattern: "^[a-z0-9-]{2,31}$"
        examples: ["agtech"]

      api_version:
        type: integer
        title: "API Version"
        description: "Tenant API version. Use to coordinate feature/behavior evolution."
        minimum: 1
        examples: [1, 2]

      description:
        type: string
        title: "Description"
        description: "Free-form description of the tenant environment."
        minLength: 0
        maxLength: 1023
        examples: ["AgriTech IoT deployment used for staging and production."]

  # -------------------------
  # Topology
  # -------------------------
  Topology:
    type: object
    title: "Topology"
    description: "Physical or logical layout of the tenant (farms/sites and deployed devices)."
    additionalProperties: false
    required: [farms]

    properties:
      farms:
        type: array
        title: "Farms"
        description: "List of farms (sites/locations) belonging to this tenant."
        default: []
        minItems: 0
        items:
          $ref: "#/$defs/Farm"

  Farm:
    type: object
    title: "Farm"
    description: "A physical site or logical grouping of devices."
    additionalProperties: false
    required: [id, name, city, devices]

    properties:
      id:
        type: string
        title: "Farm ID"
        description: "Stable identifier for the farm (lowercase kebab-case recommended)."
        pattern: "^[a-z0-9-]{2,63}$"
        examples: ["nordmark-farm"]

      name:
        type: string
        title: "Farm Name"
        description: "Human-readable name of the farm."
        minLength: 2
        maxLength: 63
        examples: ["Nordmark"]

      city:
        type: string
        title: "City"
        description: "Geographical location label for the farm."
        minLength: 2
        maxLength: 63
        examples: ["Roskilde"]

      devices:
        type: array
        title: "Devices"
        description: "Devices deployed at this farm."
        default: []
        minItems: 0
        items:
          $ref: "#/$defs/Device"

  Device:
    type: object
    title: "Device"
    description: "A physical or virtual IoT device (sensor, actuator, drone, machine)."
    additionalProperties: false
    required: [id, class, model, location]

    properties:
      id:
        type: string
        title: "Device ID"
        description: "Unique identifier of the device within the tenant."
        pattern: "^[a-z0-9-]{2,63}$"
        examples: ["temp-01", "drone-02"]

      class:
        type: string
        title: "Device Class"
        description: "Device class identifier. Must reference a key in definitions.device_classes."
        pattern: "^[a-z][a-z0-9-]{1,62}$"
        examples: ["sensor", "drone", "actuator"]

      model:
        type: string
        title: "Model"
        description: "Device model or hardware identifier."
        minLength: 1
        maxLength: 63
        examples: ["DHT22", "BME280", "x4-quadcopter"]

      location:
        type: string
        title: "Location"
        description: "Logical or physical placement label."
        minLength: 1
        maxLength: 63
        examples: ["greenhouse-1", "storage", "hangar"]

      policies:
        type: array
        title: "Device Policy Overrides"
        description: "Optional list of policy names applied specifically to this device (must reference tenant policies by name)."
        default: []
        minItems: 0
        uniqueItems: true
        items:
          type: string
          pattern: "^[a-z0-9-]{2,63}$"

  # -------------------------
  # Definitions
  # -------------------------
  Definitions:
    type: object
    title: "Definitions"
    description: "Tenant-local vocabularies referenced by devices and policies."
    additionalProperties: false
    required: [device_classes, message_classes]

    properties:
      device_classes:
        type: object
        title: "Device Classes"
        description: "Declares allowed device classifications. Keys represent class identifiers."
        default: {}
        additionalProperties:
          type: object
          description: "Optional metadata for the device class (free-form)."
          additionalProperties: true
        examples:
          - sensor: {}
            drone: {}
            actuator: {}

      message_classes:
        type: array
        title: "Message Classes"
        description: "Declares message types and their topic segments."
        default: []
        minItems: 0
        items:
          $ref: "#/$defs/MessageClass"

  MessageClass:
    type: object
    title: "Message Class"
    description: "A message category (id) and its associated topic segment."
    additionalProperties: false
    required: [id, topic]

    properties:
      id:
        type: string
        title: "Message Class ID"
        description: "Identifier of the message class."
        pattern: "^[a-z][a-z0-9-]{1,62}$"
        examples: ["metric", "event", "alert", "cmd", "image"]

      topic:
        type: string
        title: "Topic Segment"
        description: "Topic segment associated with this message class."
        pattern: "^[a-z][a-z0-9-]{1,62}$"
        examples: ["metrics", "events", "alerts", "cmds", "images"]

  # -------------------------
  # Policies
  # -------------------------
  Policy:
    type: object
    title: "Policy"
    description: "Constrains communication for device/message classes, optionally scoped to specific farms."
    additionalProperties: false
    required: [name, device_classes, message_classes, direction]

    properties:
      name:
        type: string
        title: "Policy Name"
        description: "Unique name of the policy (referenced by devices)."
        pattern: "^[a-z0-9-]{2,63}$"
        examples: ["drone-outbound-commands"]

      farms:
        type: array
        title: "Farm Scope"
        description: "Optional list of farm IDs where this policy applies. If omitted, applies to all farms."
        minItems: 1
        uniqueItems: true
        items:
          type: string
          pattern: "^[a-z0-9-]{2,63}$"

      device_classes:
        type: array
        title: "Device Classes"
        description: "Device classes governed by this policy (must reference keys in definitions.device_classes)."
        default: []
        minItems: 0
        uniqueItems: true
        items:
          type: string
          pattern: "^[a-z][a-z0-9-]{1,62}$"

      message_classes:
        type: array
        title: "Message Classes"
        description: "Message classes governed by this policy (must reference ids in definitions.message_classes)."
        default: []
        minItems: 0
        uniqueItems: true
        items:
          type: string
          pattern: "^[a-z][a-z0-9-]{1,62}$"

      direction:
        type: string
        title: "Direction"
        description: "Communication direction: PUB (publish only), SUB (subscribe only), BOTH (bidirectional)."
        enum: [PUB, SUB, BOTH]
        examples: ["SUB"]

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://example.com/schemas/tenant.schema.yaml"
title: "IoT Multi-Tenant Topology Schema v2"
type: object
required: [schema_version, tenants]

properties:
  schema_version:
    type: string
    pattern: '^[0-9]+\.[0-9]+$'

  tenants:
    type: object
    minProperties: 1
    additionalProperties:
      $ref: "#/$defs/Tenant"

$defs:

  Tenant:
    type: object
    required: [meta, topology, definitions, policies]
    properties:
      meta:
        $ref: "#/$defs/TenantMeta"
      topology:
        $ref: "#/$defs/Topology"
      definitions:
        $ref: "#/$defs/Definitions"
      policies:
        type: array
        items:
          $ref: "#/$defs/Policy"

  TenantMeta:
    type: object
    required: [short_name, full_name, api_version, mqtt]
    properties:
      short_name: { type: string }
      full_name: { type: string }
      api_version: { type: integer, minimum: 1 }
      description: { type: string }
      mqtt:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/MqttBroker"

  MqttBroker:
    type: object
    required: [id, ipv4, port]
    properties:
      id: { type: string }
      username: { type: string }
      password: { type: string }
      ipv4:
        type: string
        format: ipv4
      port:
        type: integer
        minimum: 1
        maximum: 65535
      keepalive:
        type: integer
        minimum: 1

  Topology:
    type: object
    required: [farms]
    properties:
      farms:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/Farm"

  Farm:
    type: object
    required: [id, name, city, devices]
    properties:
      id: { type: string }
      name: { type: string }
      city: { type: string }
      devices:
        type: array
        items:
          $ref: "#/$defs/Device"

  Device:
    type: object
    required: [id, class, driver, location, policies]
    properties:
      id: { type: string }
      class:
        type: string
        enum: [sensor, machine, actuator]
      driver: { type: string }
      type:
        anyOf:
          - type: string
          - type: "null"
      location: { type: string }
      interval:
        anyOf:
          - type: integer
            minimum: 1
          - type: "null"
      policies:
        type: array
        minItems: 1
        items:
          type: string

  Definitions:
    type: object
    required: [locations, device_classes, message_classes]
    properties:
      locations:
        type: array
        minItems: 1
        items:
          $ref: "#/$defs/Location"

      device_classes:
        $ref: "#/$defs/DeviceClasses"

      message_classes:
        type: array
        items:
          $ref: "#/$defs/MessageClass"

  Location:
    type: object
    required: [name, latitude, longitude]
    properties:
      name: { type: string }
      latitude:
        type: number
        minimum: -90
        maximum: 90
      longitude:
        type: number
        minimum: -180
        maximum: 180

  DeviceClasses:
    type: object
    properties:
      sensor:
        type: array
        items:
          $ref: "#/$defs/SensorClass"
      machine:
        type: array
        items:
          $ref: "#/$defs/MachineClass"
      actuator:
        type: object

  SensorClass:
    type: object
    required: [id, driver, unit, ranges, default_interval]
    properties:
      id: { type: string }
      driver: { type: string }
      unit: { type: string }
      ranges:
        type: object
        properties:
          normal: { type: string }
          low:
            anyOf:
              - type: string
              - type: "null"
          high:
            anyOf:
              - type: string
              - type: "null"
      default_interval:
        type: integer
        minimum: 1

  MachineClass:
    type: object
    required: [id, command_set]
    properties:
      id: { type: string }
      command_set:
        type: array
        items:
          $ref: "#/$defs/Command"

  Command:
    type: object
    required: [cmd]
    properties:
      cmd: { type: string }
      params:
        type: array
        items:
          type: string

  MessageClass:
    type: object
    required: [id, topic, qos, retain]
    properties:
      id: { type: string }
      topic: { type: string }
      qos:
        type: integer
        enum: [0, 1, 2]
      retain: { type: boolean }

  Policy:
    type: object
    required: [name, device_classes, message_classes, direction]
    properties:
      name: { type: string }
      farms:
        type: array
        items: { type: string }
      device_classes:
        type: array
        items: { type: string }
      message_classes:
        type: array
        items: { type: string }
      direction:
        enum: [PUB, SUB, BOTH]
